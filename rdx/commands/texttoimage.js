const axios = require("axios");
const fs = require("fs-extra");
const path = require("path");

module.exports.config = {
  name: "imagine",
  version: "4.5.0",
  credits: "SARDAR RDX",
  description: "Advanced Text-to-Image using Gemini NanoBanana Engine",
  commandCategory: "AI-Graphics",
  usages: "[any prompt]",
  cooldowns: 15
};

module.exports.run = async ({ api, event, args }) => {
  const { threadID, messageID } = event;
  const prompt = args.join(" ");

  if (!prompt) {
    return api.sendMessage("‚ö†Ô∏è Ustad ji, kuch toh imagine karwayein!\n\nExample: #imagine a samurai cat in cyberpunk city", threadID, messageID);
  }

  // üé® Professional Waiting Message
  const waitMsg = await api.sendMessage(`üåå **ùêÄùêáùêåùêÄùêÉ ùêëùêÉùêó ùêàùêåùêÄùêÜùêàùêçùêÄùêìùêàùêéùêç**\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nüß† **AI Engine:** Gemini NanoBanana\nüîÆ **Prompt:** ${prompt}\n‚åõ Visualizing your thoughts...\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ`, threadID);

  try {
    const cachePath = path.join(__dirname, "cache", `imagine_${Date.now()}.png`);
    fs.ensureDirSync(path.join(__dirname, "cache"));

    // üîó Aapka Render API Link (Fixed Endpoint)
    // Style 'none' rakha hai taake general image bane
    const apiUrl = `https://imagine-nsac.onrender.com/api/generate?prompt=${encodeURIComponent(prompt)}&style=none`;

    const response = await axios.get(apiUrl, { responseType: 'arraybuffer', timeout: 80000 });
    
    // Check if response is actually an image
    if (response.headers['content-type'].includes('application/json')) {
        throw new Error("API returned JSON instead of Image");
    }

    fs.writeFileSync(cachePath, Buffer.from(response.data));

    // Wait message ko delete karna
    api.unsendMessage(waitMsg.messageID);

    return api.sendMessage({
      body: `ü¶Ö **ùêàùêåùêÄùêÜùêàùêçùêÄùêìùêàùêéùêç ùêÇùêéùêåùêèùêãùêÑùêìùêÑ**\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nüé® **Prompt:** ${prompt}\n‚ú® Generated by Ahmad RDX AI\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ`,
      attachment: fs.createReadStream(cachePath)
    }, threadID, () => {
        if (fs.existsSync(cachePath)) fs.unlinkSync(cachePath);
    }, messageID);

  } catch (e) {
    api.unsendMessage(waitMsg.messageID);
    console.error(e);
    
    let errorMsg = "‚ùå AI is dreaming too hard! (Server Timeout).";
    if (e.response && e.response.status === 500) {
        errorMsg = "‚ùå Backend Error: Cookie expire ho gayi ya API limit reach ho gayi.";
    }
    
    return api.sendMessage(errorMsg, threadID, messageID);
  }
};
